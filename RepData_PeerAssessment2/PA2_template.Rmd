---
title: "Reproducible Research: Peer Assessment 2"
author: "GitHub: atet"
date: "July 14, 2014"
output: html_document
---

---

# Impact Analysis of Severe Weather Events on Population and Economic Health in the United States from 1950-2011

---

## 1. Synopsis

"Storms and other severe weather events can cause both public health and economic problems for communities and municipalities. Many severe events can result in fatalities, injuries, and property damage, and preventing such outcomes to the extent possible is a key concern."

Here, using the dataset from the U.S. National Oceanic and Atmospheric Administration's (NOAA) storm database (which tracks characteristics of major storms and weather events in the United States, including dates, locations, and estimates of any fatalities, injuries, and property damage), it has been determined that... INSERT SUMMARY HERE

1.) Which type(s) of weather events is most harmful with respect to U.S. population health and 2.) Which have the greatest economic consequence.

**NOTE: Histogram image is not directly embedded since if this document is viewed as an *.md file through GitHub, it will not display, therefore I am sourcing the image through Markdown instead.**

---

## 2. Data Processing
A GitHub repository was created for this document at: https://github.com/atet/coursera/tree/master/RepData_PeerAssessment2

### 2.A Loading Data
  * The original required data file archive `repdata-data-StormData.csv.bz2` and the prepared compressed `repdata-data-StormData.rds` is included in the repository
  * The following code is to convert the original `repdata-data-StormData.csv.bz2` to a compressed R object `repdata-data-StormData.rds`. Since the archive uncompressed is > 100 MB, the following code will download the archive from online, uncompress it locally to home (`~/`), load the local `repdata-data-StormData.csv` file into an R object, and then save it out as `repdata-data-StormData.rds` (which is below the GitHub 100 MB limit):
```{r load_bz2, eval=FALSE}
setwd("~/")
filepath_source      <- "https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2"
filename             <- "repdata-data-StormData"
filepath_destination <- paste("~/", filename, sep = "")
download.file(url = filepath_source, destfile = paste(filepath_destination, ".csv.bz2", sep = ""), method = "curl")
data                 <- bzfile(description = paste(filepath_destination, ".csv.bz2", sep = ""))
data                 <- read.csv(data, stringsAsFactors = FALSE) # Remember to set stringsAsFactors = FALSE
saveRDS(data, "~/repdata-data-StormData.rds")
# NOTE: repdata-data-StormData.rds is then uploaded to my GitHub repository
# We will use this for the remained of the analysis
```
  * This following code will now load the compressed `repdata-data-StormData.rds` from GitHub into R.
```{r load_rds}
setwd("~/")
filepath_source      <- "https://raw.github.com/atet/coursera/blob/master/RepData_PeerAssessment2/repdata-data-StormData.rds"
filename             <- "repdata-data-StormData"
filepath_destination <- paste("~/", filename, sep = "")
download.file(url = filepath_source, destfile = paste(filepath_destination, ".rds", sep = ""), method = "curl")
data                 <- readRDS(paste(filepath_destination, ".rds", sep = ""))
```
 * This large dataset initially contains 902,297 observations with 37 variables each as seen below:
```{r, echo=FALSE}
str(data)
```

### 2.B Cleaning Data
**2.B.i Date and time**
  * Entries are from 16 different time zones:
```{r, results='asis'}
time_zones <- data.frame(
  "Abbreviation" = c(
    "SCT","GST","UTC","AST","ADT","EST","EDT",
    "CST","CDT","MST","MDT","PST","PDT","HST","SST"),
  "Description" = c(
    "Seychelles Time","Gulf Standard Time","Universal Time Coordinated",
    "Altantic Standard Time","Altantic Daylight Time","Eastern Standard Time",
    "Eastern Daylight Time","Central Standard Time","Central Daylight Time",
    "Mountain Standard Time","Mountain Daylight Time","Pacific Standard Time",
    "Pacific Daylight Time","Hawaii-Aleutian Standard Time","Samoa Standard Time"),
  "UTC Offset" = c(
    "0400","0400","0000","-0400","-0300","-0500","-0400",
    "-0600","-0500","-0700","-0600","-0800","-0700","-1000",
    "-1100")
  )
knitr::kable(time_zones)
```
  * Create a uniform date/time value in UTC (Universal Time, Coordinated) of `POSIX` type using the `$BGN_DATE` and `$BGN_TIME`:
```{r, warning=FALSE}
# Trim $BGN_DATE since the date is correct, but the trailing time are all irrelevant 0:00:00
data$date <- gsub(" 0:00:00", "", data$BGN_DATE)
# Clean up timezone $TIME_ZONE, some values need to be changed for consistency
data$TIME_ZONE[data$TIME_ZONE == "CSt"] = "CST" # Typo
data$TIME_ZONE[data$TIME_ZONE == "CSC"] = "CST" # Typo
data$TIME_ZONE[data$TIME_ZONE == "ESt"] = "EST" # Typo
data$TIME_ZONE[data$TIME_ZONE == "ESY"] = "EST" # Typo
data$TIME_ZONE[data$TIME_ZONE == "GMT"] = "UTC" # Change GMT to UTC
data$TIME_ZONE[data$TIME_ZONE == "AKS"] = "HST" # Change AKS to HST
# Nine entries have unknown "UNK" timezones, The appropriate timezone was determined based on their $COUNTYNAME and $STATE
print(data[data$TIME_ZONE == "UNK", c("date", "COUNTYNAME", "STATE", "TIME_ZONE")])
# Detrmined the correct time zones and manually added
data[data$TIME_ZONE == "UNK" & data$COUNTYNAME == "OCONEE",]$TIME_ZONE = "EDT"
data[data$TIME_ZONE == "UNK" & data$COUNTYNAME == "HAWAII",]$TIME_ZONE = "HST"
data[data$TIME_ZONE == "UNK" & data$COUNTYNAME == "COLES",]$TIME_ZONE = "CDT"
data[data$TIME_ZONE == "UNK" & data$COUNTYNAME == "RUSH",]$TIME_ZONE = "EDT"
data[data$TIME_ZONE == "UNK" & data$COUNTYNAME == "HAMPDEN",]$TIME_ZONE = "EDT"
data[data$TIME_ZONE == "UNK" & data$COUNTYNAME == "LOVE",]$TIME_ZONE = "CDT"
data[data$TIME_ZONE == "UNK" & data$COUNTYNAME == "PERKINS",]$TIME_ZONE = "MDT"
data[data$TIME_ZONE == "UNK" & data$COUNTYNAME == "MCLENNAN",]$TIME_ZONE = "CDT"
data[data$TIME_ZONE == "UNK" & data$COUNTYNAME == "ARMSTRONG",]$TIME_ZONE = "CDT"
# Merge data with UTC signed offset time from data frame time_zones
data <- merge(
  x = data, y = time_zones[,c(1,3)],
  by.x = "TIME_ZONE", by.y = "Abbreviation")
# Combine date, time, and UTC offset into a charater vector
data$datetime <- paste(data$date, data$BGN_TIME, data$UTC.Offset, sep = " ")
# Since $BGN_TIME is given in 12-hour and 24-hour format, convert everything to 24-hour format in new column $time_24
time_24h                  <- strptime(data$datetime, format="%m/%d/%Y %H%M %z")     # E.g. "8/18/1994 2322 -0300"
time_12h                  <- strptime(data$datetime, format="%m/%d/%Y %H:%M:%S %p %z") # E.g. "8/28/2001 12:00:00 PM -1100"
time_24h[is.na(time_24h)] <- time_12h[!is.na(time_12h)] # Will produce warning, can ignore
# Make new column time_utc
data$time_utc             <- time_24h
# NOTE: Though there are various additional issues with date and time, there will be no more subsequent cleaning here.
```
**2.B.ii Necessary variables**
  * Subset the source data into only columns that relate to weather event, injury/loss-of-life, and economic impact.
  * Including the date of the event cleaned up previously as `$time_utc`, using the documentation provided by the National Weather Service ([https://d396qusza40orc.cloudfront.net/repdata%2Fpeer2_doc%2Fpd01016005curr.pdf](https://d396qusza40orc.cloudfront.net/repdata%2Fpeer2_doc%2Fpd01016005curr.pdf)), the following variables relate to weather event, injury/loss-of-life, or economic impact.
```{r, results='asis'}
variables <- data.frame(
  "Variable" = c(
    "time_utc", "EVTYPE","INJURIES","FATALITIES","PROPDMG",
    "PROPDMGEXP","CROPDMG","CROPDMGEXP"),
  "Description" = c(
    "Beginning date and time of event (UTC).", "Type of event.", "Reported injuries from event", 
    "Reported deaths from event.", "Damage to property", "Property damage exponent.", 
    "Damage to agricultural crops.", "Crop damage exponent.")
  )
knitr::kable(variables)
``` 
  * Subset the main data into the eight variables appropriate for this analysis.
```{r}
data <- data[ , colnames(data) %in% variables$Variable] 
```
**2.B.iii Monetary values**
  * To determine a single monetary value for property and crop damage, `$PROPDMG`, `$PROPDMGEXP`, `$CROPDMG`, and `$CROPDMGEXP` must be deciphered and combined.
  * The `$PROPDMG` and `$CROPDMG` values are all numerical, I will assume that the corresponding `EXP` columns are 10^exponent multipliers for these values and the value is in U.S dollars.
  * Together, `$PROPDMGEXP` and `$CROPDMGEX` have 20 unique symbols as multipliers, these need to be harmonized:
```{r, echo=FALSE}
print(unique(c(data$PROPDMGEXP, data$CROPDMGEXP)))
```
  * I will assume the following about the different exponent symbols:
```{r}
# Symbols that are missing (NA), blank (""), "+", "-", or "?" will be replaced with a zero (10^0 = 1)
data$PROPDMGEXP[is.na(data$PROPDMGEXP) | data$PROPDMGEXP == "" |
  data$PROPDMGEXP == "?" | data$PROPDMGEXP == "+" | data$PROPDMGEXP == "-"] <- 0
data$CROPDMGEXP[is.na(data$CROPDMGEXP) | data$CROPDMGEXP == "" |
  data$CROPDMGEXP == "?" | data$CROPDMGEXP == "+" | data$CROPDMGEXP == "-"] <- 0
# Symbols "h" or "H" will be replaced with 2 (H = hundred = 10^2 = 100)
data$PROPDMGEXP[data$PROPDMGEXP == "h" | data$PROPDMGEXP == "H"] <- 2
data$CROPDMGEXP[data$CROPDMGEXP == "h" | data$CROPDMGEXP == "H"] <- 2
# Symbols "k" or "K" will be replaced with 3 (K = kilo = thousand = 10^3 = 1000)
data$PROPDMGEXP[data$PROPDMGEXP == "k" | data$PROPDMGEXP == "K"] <- 3
data$CROPDMGEXP[data$CROPDMGEXP == "k" | data$CROPDMGEXP == "K"] <- 3
# Symbols "m" or "M" will be replaced with 6 (M = mega = million = 10^6 = 1000000)
data$PROPDMGEXP[data$PROPDMGEXP == "m" | data$PROPDMGEXP == "M"] <- 6
data$CROPDMGEXP[data$CROPDMGEXP == "m" | data$CROPDMGEXP == "M"] <- 6
# Symbols "m" or "M" will be replaced with 9 (B = billion = 10^9 = 1000000000)
data$PROPDMGEXP[data$PROPDMGEXP == "b" | data$PROPDMGEXP == "B"] <- 9
data$CROPDMGEXP[data$CROPDMGEXP == "b" | data$CROPDMGEXP == "B"] <- 9
# The remaining symbols are already numberic and assumed correct exponents
# Make column $total_damage that combines the total property and crop damage
data$total_damage <- (data$PROPDMG * (10 ^ as.numeric(data$PROPDMGEXP))) + (data$CROPDMG * (10 ^ as.numeric(data$CROPDMGEXP)))
```
**2.B.iv Event type**
  * The recorded event types are different between years (source: [http://www.ncdc.noaa.gov/stormevents/details.jsp?type=eventtype](http://www.ncdc.noaa.gov/stormevents/details.jsp?type=eventtype)):
    * 1950-1955: Tornadoes
    * 1955-1996: Tornadoes, thunderstorm winds, and hail
    * 1996-present: 48 different event types
  * Initially, there are 985 different unique `$EVTYPE` which describe the weather event.
  * Clearly there are differences between labels and typos present, therefore these labels need to be harmonized.
  * I will only consider the following types of events (with priority):
    1. Cold-related (e.g. "GROUND BLIZZARD", "ICE STORM", "RECORD SNOWFALL", etc.)
    2. Heat-related (e.g. "EXCESSIVE HEAT", "WILD/FOREST FIRE")
    3. Coastal (e.g. "Heavy surf and wind", "Beach Erosion", "TSUNAMI", etc.)
    4. Wind-only (e.g. "High winds", "GUSTNADO", "TORNADO", etc.)
    5. Rain-only (e.g. "Mudslides", "RAPIDLY RISING WATER", "Wet Year", etc.)
    6. Other, entries with `$EVTYPE` labels that are incomplete or "?", "Summary of...", ""No Severe Weather"",  etc.

```{r}
# Replace original terms with one of the five terms using regular expressions and list of related words
# Cold-related events
data$EVTYPE[
  grepl(
    "cold|cool|snow|ice|frost|freez|icy|chill|blizzard|wint|low|glaze|fog|avalanche|avalance|hypothermia",
    data$EVTYPE, ignore.case = TRUE)
  ] <- "cold"
# Heat-related events
data$EVTYPE[
  grepl(
    "heat|high|fire|hot|warm|drought|dry|driest",
    data$EVTYPE, ignore.case = TRUE)
  ] <- "heat"
# Coastal events
data$EVTYPE[
  grepl(
    "coastal|seas|slump|beach|tsunami|current|marine|tidal|tide|hurricane|surf|typhoon|swell|spout|seiche|tropical|cstl|wave",
    data$EVTYPE, ignore.case = TRUE)
  ] <- "coastal"
# Wind-only events
data$EVTYPE[
  grepl(
    "wind|wnd|gust|dust|smoke|ash|funnel|cloud|burst|tornado|torndao|volcanic", 
    data$EVTYPE, ignore.case = TRUE)
  ] <- "wind"
# Rain-only events
data$EVTYPE[
  grepl(
    "rain|flood|fldg|storm|slide|hail|sleet|precip|stream|wet|light|lignt|cloud|tstm|fog|vog|water|shower|mix",
    data$EVTYPE, ignore.case = TRUE) 
  ] <- "rain"
# "Other" events
data$EVTYPE[
  !grepl(
    "cold|heat|coastal|wind|rain",
    data$EVTYPE, ignore.case = TRUE) 
  ] <- "other"
# Resulting distribution of events by these six different event categories
print(table(data$EVTYPE))
```
 
  * For the purposes of this study, I will now consider the `data` to be harmonized, clean, and ready for analysis.
```{r, echo=FALSE}
print(str(data))
```
---

## 3. Results

### 3.A Population Health Impact Resulting From Weather Events
  * INSERT DESCRIPTION
```{r figure1, fig.width=8, fig.height=5, fig.show="hide"}
health_by_event <- rbind(
  data.frame(
    event = c("Coastal","Cold","Heat","Other","Rain","Wind"),
    count = tapply(X = data$INJURIES, INDEX = data$EVTYPE, FUN = sum),
    type = "Injury"),
  data.frame(
    event = c("Coastal","Cold","Heat","Other","Rain","Wind"),
    count = tapply(X = data$FATALITIES, INDEX = data$EVTYPE, FUN = sum),
    type = "Fatality"))

library(ggplot2)

ggplot(health_by_event, aes(x = event, y = count, fill = type)) + 
  geom_bar(position = "dodge", stat = "identity") +
  labs(x = "Weather Event", y = "Counts",
       title = "Number of Injury/Fatalities per Weather Event\nin the United States (1950-2011)") +
  scale_fill_discrete(name = "Health Impact\nType") +
  geom_text(aes(label = formatC(round(count, digits = 1), format = "d", big.mark = ",", small.mark = ".", width = 2), ymax = 0), size = 5, position = position_dodge(width = 1), vjust = -1)
```

![Alt text](https://raw.githubusercontent.com/atet/coursera/RepData_PeerAssessment2/master/figure/fig1.png)

### 3.B Economic Impact Resulting From Weather Events
  * INSERT DESCRIPTION
```{r figure2, fig.width=8, fig.height=5, fig.show="hide"}
economic_by_event <- data.frame(
    event = c("Coastal","Cold","Heat","Other","Rain","Wind"),
    usd_mil = tapply(X = data$total_damage, INDEX = data$EVTYPE, FUN = sum) / 1000000)

library(ggplot2)

ggplot(economic_by_event, aes(x = event, y = usd_mil)) + 
  geom_bar(fill = "white", colour = "darkgreen", stat = "identity") +
  labs(x = "Weather Event", y = "Total Property + Crop Damage (in millions of dollars USD)",
       title = "Cost of Property and Crop Damage per Weather Event\nin the United States (1950-2011)") +
  geom_text(aes(label = paste("$", formatC(round(usd_mil, digits = 1), format = "d", big.mark = ",", small.mark = ".", width = 2), sep = ""), ymax = 0), size = 5, vjust = -1)
```

![Alt text](https://raw.githubusercontent.com/atet/coursera/RepData_PeerAssessment2/master/figure/fig2.png)

---

## 4. Discussion

**1. Across the United States, which types of events (as indicated in the EVTYPE variable) are most harmful with respect to population health?**

**2. Across the United States, which types of events have the greatest economic consequences?**

---
---